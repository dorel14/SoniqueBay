#!/usr/bin/env python3
"""
Test simple de la configuration Celery
Teste les configurations et imports sans d√©marrer de workers.
"""

import sys
import os
from pathlib import Path

def test_celery_imports():
    """Test des imports Celery."""
    
    print("=== TEST DES IMPORTS CELERY ===\n")
    
    try:
        # Test import celery
        from celery import Celery
        print("‚úì Import Celery r√©ussi")
        
        # Test import worker
        from backend_worker.celery_app import celery
        print("‚úì Import backend_worker.celery_app r√©ussi")
        
        return True
        
    except ImportError as e:
        print(f"‚úó Erreur d'import: {str(e)}")
        return False
    except Exception as e:
        print(f"‚úó Erreur inattendue: {str(e)}")
        return False

def test_celery_configuration():
    """Test de la configuration Celery."""
    
    print("\n=== TEST DE LA CONFIGURATION CELERY ===\n")
    
    try:
        from backend_worker.celery_app import celery
        
        # Test des configurations
        configs = {
            "broker_url": celery.conf.broker_url,
            "task_queues": len(celery.conf.task_queues) if hasattr(celery.conf, 'task_queues') else "Non d√©fini",
            "worker_queues": len(celery.conf.worker_queues) if hasattr(celery.conf, 'worker_queues') else "Non d√©fini",
            "task_routes": len(celery.conf.task_routes) if hasattr(celery.conf, 'task_routes') else "Non d√©fini"
        }
        
        for key, value in configs.items():
            print(f"‚úì {key}: {value}")
        
        return True
        
    except Exception as e:
        print(f"‚úó Erreur de configuration: {str(e)}")
        return False

def test_celery_tasks_registration():
    """Test de l'enregistrement des t√¢ches Celery."""
    
    print("\n=== TEST D'ENREGISTREMENT DES T√ÇCHES ===\n")
    
    try:
        from backend_worker.celery_app import celery
        
        # Lister les t√¢ches connues
        tasks = list(celery.tasks.keys())
        
        print(f"‚úì Nombre de t√¢ches enregistr√©es: {len(tasks)}")
        
        # Afficher quelques t√¢ches importantes
        important_tasks = [
            'scan.discovery',
            'metadata.extract_batch', 
            'batch.process_entities',
            'insert.direct_batch'
        ]
        
        for task in important_tasks:
            if task in tasks:
                print(f"  ‚úì {task}")
            else:
                print(f"  ‚úó {task} - NON TROUV√âE")
        
        return True
        
    except Exception as e:
        print(f"‚úó Erreur lors de l'enregistrement des t√¢ches: {str(e)}")
        return False

def test_worker_modules():
    """Test de l'import des modules workers."""
    
    print("\n=== TEST DES MODULES WORKERS ===\n")
    
    worker_modules = [
        'backend_worker.workers.metadata.extract_metadata_worker',
        'backend_worker.workers.batch.process_entities_worker', 
        'backend_worker.workers.insert.insert_batch_worker',
        'backend_worker.celery_tasks'
    ]
    
    all_passed = True
    
    for module_name in worker_modules:
        try:
            __import__(module_name)
            print(f"‚úì {module_name}")
        except ImportError as e:
            print(f"‚úó {module_name}: {str(e)}")
            all_passed = False
        except Exception as e:
            print(f"‚úó {module_name}: {str(e)}")
            all_passed = False
    
    return all_passed

def main():
    """Ex√©cution de tous les tests."""
    
    print("üîß TEST DE LA CONFIGURATION CELERY")
    print("=" * 60)
    
    # Test 1: Imports
    result1 = test_celery_imports()
    
    # Test 2: Configuration
    result2 = test_celery_configuration()
    
    # Test 3: Enregistrement des t√¢ches
    result3 = test_celery_tasks_registration()
    
    # Test 4: Modules workers
    result4 = test_worker_modules()
    
    # R√©sum√©
    print("\n" + "=" * 60)
    print("üìä R√âSUM√â")
    print("=" * 60)
    
    tests = [
        ("Imports Celery", result1),
        ("Configuration Celery", result2),
        ("Enregistrement des t√¢ches", result3),
        ("Modules workers", result4)
    ]
    
    passed = sum(1 for _, result in tests if result)
    total = len(tests)
    
    for test_name, result in tests:
        status = "‚úì" if result else "‚úó"
        print(f"{status} {test_name}")
    
    print(f"\nR√©sultat: {passed}/{total} tests pass√©s")
    
    if passed == total:
        print("‚úÖ TOUS LES TESTS SONT PASS√âS!")
        print("La configuration Celery semble correcte.")
        return 0
    else:
        print("‚ùå CERTAINS TESTS ONT √âCHOU√â")
        return 1

if __name__ == "__main__":
    sys.exit(main())